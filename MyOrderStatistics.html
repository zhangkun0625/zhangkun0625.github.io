<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>多产品销售数据记录</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 5px;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <h2>产品销售数据输入</h2>
    <form id="dataForm">
      日期: <input type="date" id="date" /><br />
      15寸订单量: <input type="number" id="product15OrderQty" /> 销售数:
      <input type="number" id="product15SalesQty" /><br />
      18寸订单量: <input type="number" id="product18OrderQty" /> 销售数:
      <input type="number" id="product18SalesQty" /><br />
      4x10订单量: <input type="number" id="product4x10OrderQty" /> 销售数:
      <input type="number" id="product4x10SalesQty" /><br />
      <button type="button" onclick="addData()">添加数据</button>
    </form>

    <button onclick="clearAllData()">清除所有数据</button>
    <button onclick="exportData()">导出数据为JSON</button>
    <button onclick="loadSalesData()">导入数据</button>
    <button onclick="createCharts()">绘图</button>

    <h2>产品销售数据表格</h2>
    <table id="data-table">
      <thead>
        <tr>
          <th>日期</th>
          <th>15寸订单量</th>
          <th>15寸销售数</th>
          <th>18寸订单量</th>
          <th>18寸销售数</th>
          <th>4x10订单量</th>
          <th>4x10销售数</th>
          <th>15寸订单总量</th>
          <th>15寸销售总数</th>
          <th>18寸订单总量</th>
          <th>18寸销售总数</th>
          <th>4x10订单总量</th>
          <th>4x10销售总数</th>
        </tr>
      </thead>
      <tbody>
        <!-- 数据行将被动态添加到此处 -->
      </tbody>
    </table>

    <h2>图表</h2>
    <div>
      <canvas id="myChart" width="400" height="200"></canvas>
      <!-- <canvas id="chart-18寸" width="400" height="200"></canvas>
      <canvas id="chart-4x10"></canvas> -->
    </div>

    <script>
      // 存储数据的数组
      let salesData = [];

      // 从本地文件加载销售数据
      function loadSalesData() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.onchange = function (event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = JSON.parse(e.target.result);
              if (Array.isArray(data)) {
                // 只保留订单量和销售数，删除订单总量和销售总数
                salesData = data.map((entry) => ({
                  date: entry.date,
                  orderQuantity15: entry.orderQuantity15,
                  salesQuantity15: entry.salesQuantity15,
                  orderQuantity18: entry.orderQuantity18,
                  salesQuantity18: entry.salesQuantity18,
                  orderQuantity4x10: entry.orderQuantity4x10,
                  salesQuantity4x10: entry.salesQuantity4x10,
                  // 初始化导入的累计总数
                  totalOrders15: 0,
                  totalSales15: 0,
                  totalOrders18: 0,
                  totalSales18: 0,
                  totalOrders4x10: 0,
                  totalSales4x10: 0,
                }));

                updateRunningTotals(); // 更新累计总数
                renderTable();
              } else {
                throw new Error('数据格式不正确，应为数组格式。');
              }
            } catch (error) {
              alert(error.message);
            }
          };
          reader.readAsText(file);
        };
        fileInput.click(); // 触发点击以打开文件选择对话框
      }

      // 添加数据到表格
      function addData() {
        const date = document.getElementById('date').value;
        const quantities = {
          orderQuantity15:
            parseInt(document.getElementById('product15OrderQty').value, 10) ||
            0,
          salesQuantity15:
            parseInt(document.getElementById('product15SalesQty').value, 10) ||
            0,
          orderQuantity18:
            parseInt(document.getElementById('product18OrderQty').value, 10) ||
            0,
          salesQuantity18:
            parseInt(document.getElementById('product18SalesQty').value, 10) ||
            0,
          orderQuantity4x10:
            parseInt(
              document.getElementById('product4x10OrderQty').value,
              10
            ) || 0,
          salesQuantity4x10:
            parseInt(
              document.getElementById('product4x10SalesQty').value,
              10
            ) || 0,
        };

        // 不再包含订单总量和销售总数
        salesData.push({
          date: date,
          ...quantities,
        });

        updateRunningTotals(); // 更新累计总数

        renderTable();
        clearInputs();
      }

      // 清除所有数据
      function clearAllData() {
        salesData = [];
        renderTable();
        clearInputs();
      }

      // 清空输入框
      function clearInputs() {
        document.getElementById('date').value = '';
        document.getElementById('product15OrderQty').value = '';
        document.getElementById('product15SalesQty').value = '';
        document.getElementById('product18OrderQty').value = '';
        document.getElementById('product18SalesQty').value = '';
        document.getElementById('product4x10OrderQty').value = '';
        document.getElementById('product4x10SalesQty').value = '';
      }

      //更新累加的数据
      function updateRunningTotals() {
        let runningTotals = {
          totalOrders15: 0,
          totalSales15: 0,
          totalOrders18: 0,
          totalSales18: 0,
          totalOrders4x10: 0,
          totalSales4x10: 0,
        };

        salesData.forEach((entry) => {
          runningTotals.totalOrders15 += entry.orderQuantity15;
          runningTotals.totalSales15 += entry.salesQuantity15;
          runningTotals.totalOrders18 += entry.orderQuantity18;
          runningTotals.totalSales18 += entry.salesQuantity18;
          runningTotals.totalOrders4x10 += entry.orderQuantity4x10;
          runningTotals.totalSales4x10 += entry.salesQuantity4x10;

          // 更新到每个条目
          entry.totalOrders15 = runningTotals.totalOrders15;
          entry.totalSales15 = runningTotals.totalSales15;
          entry.totalOrders18 = runningTotals.totalOrders18;
          entry.totalSales18 = runningTotals.totalSales18;
          entry.totalOrders4x10 = runningTotals.totalOrders4x10;
          entry.totalSales4x10 = runningTotals.totalSales4x10;
        });
      }

      // 渲染表格
      function renderTable() {
        // 获取表格的tbody元素
        const tableBody = document
          .getElementById('data-table')
          .getElementsByTagName('tbody')[0];
        // 清空现有的表格数据
        tableBody.innerHTML = '';

        // 初始化累计总数对象
        let runningTotals = {
          totalOrders15: 0,
          totalSales15: 0,
          totalOrders18: 0,
          totalSales18: 0,
          totalOrders4x10: 0,
          totalSales4x10: 0,
        };

        // 遍历销售数据，计算每个产品的累计订单量和销售数
        salesData.forEach((entry) => {
          // 累加订单量和销售数到对应的累计总数
          runningTotals.totalOrders15 += entry.orderQuantity15;
          runningTotals.totalSales15 += entry.salesQuantity15;
          runningTotals.totalOrders18 += entry.orderQuantity18;
          runningTotals.totalSales18 += entry.salesQuantity18;
          runningTotals.totalOrders4x10 += entry.orderQuantity4x10;
          runningTotals.totalSales4x10 += entry.salesQuantity4x10;

          // 创建新的表格行并填充数据
          const row = tableBody.insertRow();
          row.insertCell(0).textContent = entry.date;
          row.insertCell(1).textContent = entry.orderQuantity15;
          row.insertCell(2).textContent = entry.salesQuantity15;
          row.insertCell(3).textContent = entry.orderQuantity18;
          row.insertCell(4).textContent = entry.salesQuantity18;
          row.insertCell(5).textContent = entry.orderQuantity4x10;
          row.insertCell(6).textContent = entry.salesQuantity4x10;
          row.insertCell(7).textContent = runningTotals.totalOrders15;
          row.insertCell(8).textContent = runningTotals.totalSales15;
          row.insertCell(9).textContent = runningTotals.totalOrders18;
          row.insertCell(10).textContent = runningTotals.totalSales18;
          row.insertCell(11).textContent = runningTotals.totalOrders4x10;
          row.insertCell(12).textContent = runningTotals.totalSales4x10;
        });
      }

      // 导出数据功能
      function exportData() {
        const dataStr = JSON.stringify(salesData, null, 2);
        const blob = new Blob([dataStr], {
          type: 'application/json;charset=utf-8',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sales-data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      //绘制图表===========================
      //   function createChartssssss() {
      //     // 检查 Chart.js 是否已加载
      //     if (typeof Chart === 'undefined') {
      //       console.error('Chart.js 未加载，将在 1 秒后重试...');
      //       setTimeout(createCharts, 1000);
      //       return;
      //     }

      //     const ctx = document.getElementById('myChart');
      //     const labels = [
      //       '一月份',
      //       '二月份',
      //       '三月份',
      //       '四月份',
      //       '五月份',
      //       '六月份',
      //       '七月份',
      //     ]; // 设置 X 轴上对应的标签
      //     const data = {
      //       labels: labels,
      //       datasets: [
      //         {
      //           label: '我的第一个折线图',
      //           data: [65, 59, 80, 81, 56, 55, 40],
      //           fill: false,
      //           borderColor: 'rgb(75, 192, 192)', // 设置线的颜色
      //           backgroundColor: ['rgba(179, 0, 33, 0.5)'], // 设置点的填充色
      //           pointStyle: 'circle', //设置点类型为圆点
      //           pointRadius: 6, //设置圆点半径
      //           pointHoverRadius: 10, //设置鼠标移动上去后圆点半径
      //           tension: 0.1,
      //         },
      //       ],
      //     };
      //     const config = {
      //       type: 'line', // 设置图表类型
      //       data: data,
      //       options: {
      //         responsive: true, // 设置图表为响应式

      //         interaction: {
      //           // 设置每个点的交互
      //           intersect: false,
      //         },
      //         scales: {
      //           // 设置 X 轴与 Y 轴
      //           x: {
      //             display: true,
      //             title: {
      //               display: true,
      //               text: '日期',
      //             },
      //           },
      //           y: {
      //             display: true,
      //             title: {
      //               display: true,
      //               text: '票数',
      //             },
      //           },
      //         },
      //       },
      //     };
      //     const myChart = new Chart(ctx, config);
      //   }

      function createCharts() {
        // 检查 Chart.js 是否已加载
        if (typeof Chart === 'undefined') {
          console.error('Chart.js 未加载，将在 1 秒后重试...');
          setTimeout(createCharts, 1000);
          return;
        }

        // 准备15寸产品的数据
        const chartData15 = {
          labels: [], // 将被填充为日期
          datasets: [
            {
              label: '15寸订单总量',
              data: [], // 将被填充为每天的订单总量
              borderColor: 'rgb(75, 192, 192)',
              fill: false,
            },
            {
              label: '15寸销售总数',
              data: [], // 将被填充为每天的销售总数
              borderColor: 'rgb(153, 102, 255)',
              fill: false,
            },
          ],
        };

        // 填充15寸产品的数据
        salesData.forEach((entry) => {
          const date = new Date(entry.date).toLocaleDateString(); // 格式化日期
          chartData15.labels.push(date);
          chartData15.datasets[0].data.push(entry.totalOrders15); // 订单总量
          chartData15.datasets[1].data.push(entry.totalSales15); // 销售总数
        });

        // 获取15寸图表的画布和上下文
        const chartCanvas15 = document.getElementById('myChart');
        if (chartCanvas15) {
          const chartCtx15 = chartCanvas15.getContext('2d');

          // 检查是否已经有图表实例
          let chart15 = new Chart(chartCtx15, {
            type: 'line',
            data: chartData15,
            options: {
              scales: {
                // x: {
                //   type: 'time',
                //   time: {
                //     unit: 'day',
                //   },
                // },
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        }
      }
    </script>
  </body>
</html>
